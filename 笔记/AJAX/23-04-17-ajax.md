# AJAX

## 简介

AJAX 最大的优点是在不重新加载整个页面的情况下，可以与服务器交换数据并更新部分网页内容。

AJAX 不需要任何浏览器插件，但需要用户允许 JavaScript 在浏览器上执行。

XMLHttpRequest 只是实现 Ajax 的一种方式。

## 快速入门

### Servlet后端

```java
resp.getWriter().write("Success Data");
```

### js-AJAX 快速入门

```html
<html>
<body>
<h2>Hello World!</h2>
<p id="demo"></p>
</body>
<script>
  var xhr = new XMLHttpRequest();
 
  xhr.onload = function () {
      // 输出接收到的文字数据
      document.getElementById("demo").innerHTML=xhr.responseText;
  }
  
  xhr.onerror = function () {
      document.getElementById("demo").innerHTML="请求出错";
  }
  
  // 发送异步 GET 请求
  xhr.open("GET", "/ajaxtest/emp?method=test", true);
  xhr.send();
</script>
</html>

```

### jq-AJAX 快速入门

```html
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<body>
<h2>Hello World!</h2>
<p id="demo"></p>
</body>
<button>发送一个 HTTP GET 请求并获取返回结果</button>
<script>
$(document).ready(function(){
	$("button").click(function(){
		$.get("/ajaxtest/emp?method=test",function(data,status){
			alert("数据: " + data + "\n状态: " + status);
		});
	});
});
</script>
</html>
```

## AJAX 工作原理

![1681709497496](image/23-04-17-ajax/1681709497496.png)

## 创建 **XMLHttpRequest** 对象

XMLHttpRequest 是 AJAX 的基础。

### XMLHttpRequest 对象

所有现代浏览器均支持 XMLHttpRequest 对象（IE5 和 IE6 使用 ActiveXObject）。

XMLHttpRequest 用于在后台与服务器交换数据。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。

### 创建 XMLHttpRequest 对象

所有现代浏览器（IE7+、Firefox、Chrome、Safari 以及 Opera）均内建 XMLHttpRequest 对象。

创建 XMLHttpRequest 对象的语法：

```js
variable=new XMLHttpRequest();
```

老版本的 Internet Explorer （IE5 和 IE6）使用 ActiveX 对象：

```js
variable=new ActiveXObject("Microsoft.XMLHTTP");
```

为了应对所有的现代浏览器，包括 IE5 和 IE6，请检查浏览器是否支持 XMLHttpRequest 对象。如果支持，则创建 XMLHttpRequest 对象。如果不支持，则创建 ActiveXObject ：

```js
var xmlhttp;
if (window.XMLHttpRequest){
    //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
    xmlhttp=new XMLHttpRequest();
}
else{
    // IE6, IE5 浏览器执行代码
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
}
```

## 向服务器发送**请求**

XMLHttpRequest 对象用于和服务器交换数据。

### 发送请求的方法

如需将请求发送到服务器，我们使用 **XMLHttpRequest** 对象的 **open()** 和 **send()** 方法：

```js
xmlhttp.open("GET","ajax_info.txt",true);
xmlhttp.send();
```

| 方法                                    | 描述                                                                                                                                                                          |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| open(*method* , *url* , *async* ) | 规定请求的类型、URL 以及是否异步处理请求。<br />**method* ：请求的类型；GET 或 POST<br /> *url* ：文件在服务器上的位置* <br /> *async* ：true（异步）或 false（同步） |
| send(*string* )                       | 将请求发送到服务器。*string* ：仅用于 POST 请求                                                                                                                             |

### GET 还是 POST？

与 POST 相比，GET 更简单也更快，并且在大部分情况下都能用。

然而，在以下情况中，请使用 POST 请求：

* 不愿使用缓存文件（更新服务器上的文件或数据库）
* 向服务器发送大量数据（POST 没有数据量限制）
* 发送包含未知字符的用户输入时，POST 比 GET 更稳定也更可靠

### onload和onreadystatechange区别

#### onreadystatechange

当网络请求码为200（服务器成功返回网页），readyState状态码为4时（请求已完成，响应已就绪），方可打印请求的数据。如图，在readyState状态码3的情况下不会再打印请求返回的数据。

```js
function loadText(){
            let xhr = new XMLHttpRequest();
            xhr.open('GET','sample.txt',true);
            console.log("READYSTATE"+ xhr.readyState);
            xhr.onreadystatechange = function(){
                console.log("READYSTATE"+ xhr.readyState);
                if(this.status == 200 && this.readyState == 4){
                    console.log(this.responseText);
                }else if(this.status == 404){
                    console.log("网页不存在");
                }
              
            }
            xhr.send();
        }
```

#### onload

当网络请求码为200（服务器成功返回网页），readyState状态码为4时（请求已完成，响应已就绪），方可打印请求的数据。如图，在readyState状态码3的情况下不会再打印请求返回的数据。

```js
 function loadText(){
            let xhr = new XMLHttpRequest();
            xhr.open('GET','sample.txt',true);
            console.log("READYSTATE"+ xhr.readyState);
            //两种请求方式onload和onreadystatechange
            xhr.onload = function(){
                console.log("READYSTATE"+ xhr.readyState);
                console.log(this.responseText);
            }
            xhr.send();
}
```
